# ã‚·ãƒŠãƒªã‚ªæ¡ˆ

- å•é¡Œï¼šåˆ†æå®Ÿè£…å¾Œã®ã‚¢ãƒ©ãƒ¼ãƒ ã®å†è¨­å®šæ¤œè¨ã‚„ä»•çµ„ã¿ã‚’ç†è§£ã™ã‚‹ãŸã‚ã®æ™‚é–“ãŒå¢—ãˆä½œæ¥­è² è·ãŒå¢—å¤§ã—ãŸã‚ˆã†ã«æ„Ÿã˜ã‚‹
- èª²é¡Œï¼šã‚¢ãƒ©ãƒ¼ãƒ ã«å¯¾ã—ã¦æ¬¡ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’è€ƒãˆã‚‹ã“ã¨ãŒ(æ™‚é–“ãŒã‹ã‹ã£ãŸã‚ŠæŠ€è¡“ãŒç„¡ã)é›£ã—ã„

â€» äº‹å‰ã«å…¥åŠ›ã¨ã—ã¦ç¾åœ¨è¨­å®šã—ã¦ã„ã‚‹é–¾å€¤ã‚’æŒã£ã¦ã„ã‚‹ã“ã¨ã¨ã™ã‚‹ã€‚

- ã‚¢ãƒ©ãƒ¼ãƒ ç™ºç”Ÿã‹ã‚‰ãã‚Œä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ã€ãƒ‡ãƒ¼ã‚¿åˆ†å¸ƒã‚„æ™‚ç³»åˆ—ã§ã®çŠ¶æ³ã‚’å¯è¦–åŒ–+GPTã§ãƒ‡ãƒ¼ã‚¿ã®æ¦‚è¦ã‚’ç”Ÿæˆã™ã‚‹ã€‚(â—‹â—‹ã«ç™ºç”Ÿã—ãŸã‚¢ãƒ©ãƒ¼ãƒ ã§ã¯HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹â—‹â—‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã€å‡¦ç†ãŒæ­£å¸¸çµ‚äº†ã—ãªã‹ã£ãŸãŸã‚ã‚¢ãƒ©ãƒ¼ãƒ ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã“ã®ã‚¢ãƒ©ãƒ¼ãƒ ã®ç›´å‰ã«ã¯â—‹â—‹ãŒèµ·ãã¦ãŠã‚Šã€ã“ã®ã‚¢ãƒ©ãƒ¼ãƒ ã‚ˆã‚Šå‰ã®ãƒ‡ãƒ¼ã‚¿â—‹â—‹å€‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã¿ã‚‹ã¨...)
- ã‚¢ãƒ©ãƒ¼ãƒ ç™ºç”Ÿã‹ã‚‰ãã‚Œä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã„ç°¡æ˜“çš„ãªåˆ†æã‚’å®Ÿæ–½ã€æ–°ã—ã„é–¾å€¤ã®ææ¡ˆã¨ãã®å ´åˆãƒ‡ãƒ¼ã‚¿ã¯ã©ã®ã‚ˆã†ã«èª­ã¿å–ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã®ã‹ã‚’ç¾çŠ¶ã¨æ¯”è¼ƒã—ã¦ã®æ¦‚è¦èª¬æ˜ã‚’GPTãƒ¢ãƒ‡ãƒ«ã§ç”Ÿæˆã™ã‚‹
    - é–¾å€¤è¨­å®šç”¨ã®åˆ†æã¯ã€å–å¾—ãƒ‡ãƒ¼ã‚¿ã®åˆ†å¸ƒ95%ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ­£å¸¸ã¨ã—ã€5%ã‚’ç•°å¸¸ã¨ã™ã‚‹å½¢ã§Hold Outæ³•ã§æ•™å¸«ãªã—ã§åˆ†æã‚’å®Ÿæ–½ã™ã‚‹ã€‚æ™‚ç³»åˆ—ã‚’è€ƒæ…®ã—ãŸARIMAã§ã®åˆ†æã‚‚ã—ãŸã„ãª

ã‚ãŸã‹ã‚‚GPTãƒ¢ãƒ‡ãƒ«ãŒãƒ‡ãƒ¼ã‚¿ã®èª¬æ˜ãƒ»å¯è¦–åŒ–ã€é–¾å€¤ã®å†è¨­å®šæ¡ˆã®æç¤ºã¾ã§è‡ªå‹•ã§ã‚„ã£ã¦ãã‚Œã‚‹æ„Ÿã˜ã«ã—ãŸã„<br>
å…¥å‡ºåŠ›ã®ã‚ã„ã¾ã„ã•ã‚’è¨±ã—ã¤ã¤å‡ºåŠ›ã®æ›–æ˜§ã•ã¯ãƒ«ãƒ¼ãƒ«ã§è£œã†å½¢ã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã™ã‚‹

- ã‚¢ãƒ©ãƒ¼ãƒ ã«å¯¾ã—ã¦æ¬¡ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æç¤ºã™ã‚‹ãŸã‚ã‚¢ãƒ©ãƒ¼ãƒ ç™ºå ±æ™‚ã®ãƒ‡ãƒ¼ã‚¿ã®é‡è¦åº¦ã®é«˜ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã„ãã¤ã‹æŠ½å‡º(HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæŠ½å‡ºã•ã‚Œã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸)ã—ã€ReActã§DBã¾ãŸã¯ãƒãƒƒãƒˆã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã«é–¢é€£ã™ã‚‹æƒ…å ±ã‚’ã‚‚ã¨ã«æ¬¡ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ç”Ÿæˆã™ã‚‹


```python
!pip install japanize-matplotlib
```

    Requirement already satisfied: japanize-matplotlib in /usr/local/lib/python3.10/dist-packages (1.1.3)
    Requirement already satisfied: matplotlib in /usr/local/lib/python3.10/dist-packages (from japanize-matplotlib) (3.7.1)
    Requirement already satisfied: contourpy>=1.0.1 in /usr/local/lib/python3.10/dist-packages (from matplotlib->japanize-matplotlib) (1.0.7)
    Requirement already satisfied: cycler>=0.10 in /usr/local/lib/python3.10/dist-packages (from matplotlib->japanize-matplotlib) (0.11.0)
    Requirement already satisfied: fonttools>=4.22.0 in /usr/local/lib/python3.10/dist-packages (from matplotlib->japanize-matplotlib) (4.39.3)
    Requirement already satisfied: kiwisolver>=1.0.1 in /usr/local/lib/python3.10/dist-packages (from matplotlib->japanize-matplotlib) (1.4.4)
    Requirement already satisfied: numpy>=1.20 in /usr/local/lib/python3.10/dist-packages (from matplotlib->japanize-matplotlib) (1.23.5)
    Requirement already satisfied: packaging>=20.0 in /usr/local/lib/python3.10/dist-packages (from matplotlib->japanize-matplotlib) (23.1)
    Requirement already satisfied: pillow>=6.2.0 in /usr/local/lib/python3.10/dist-packages (from matplotlib->japanize-matplotlib) (9.5.0)
    Requirement already satisfied: pyparsing>=2.3.1 in /usr/lib/python3/dist-packages (from matplotlib->japanize-matplotlib) (2.4.7)
    Requirement already satisfied: python-dateutil>=2.7 in /usr/local/lib/python3.10/dist-packages (from matplotlib->japanize-matplotlib) (2.8.2)
    Requirement already satisfied: six>=1.5 in /usr/lib/python3/dist-packages (from python-dateutil>=2.7->matplotlib->japanize-matplotlib) (1.16.0)
    [33mWARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv[0m[33m
    [0m


```python
# ã‚¢ãƒ©ãƒ¼ãƒ å‰ã¾ã§ä»®å®šã§è¨­å®šã—ã¦ã„ã‚‹é–¾å€¤(ç¾åœ¨è¨­å®šä¸­ã®é–¾å€¤)
threshold = 1000
```


```python
from contextlib import contextmanager
from time import time

class Timer:
    """å‡¦ç†æ™‚é–“ã‚’è¡¨ç¤ºã™ã‚‹ã‚¯ãƒ©ã‚¹
    with Timer(prefix=f'pred cv={i}'):
        y_pred_i = predict(model, loader=test_loader)
    
    with Timer(prefix='fit fold={} '.format(i)):
        clf.fit(x_train, y_train, 
                eval_set=[(x_valid, y_valid)],  
                early_stopping_rounds=100,
                verbose=verbose)

    with Timer(prefix='fit fold={} '.format(i), verbose=500):
        clf.fit(x_train, y_train, 
                eval_set=[(x_valid, y_valid)],  
                early_stopping_rounds=100,
                verbose=verbose)
    """
    def __init__(self, logger=None, format_str='{:.3f}[s]', prefix=None, suffix=None, sep=' ', verbose=0):

        if prefix: format_str = str(prefix) + sep + format_str
        if suffix: format_str = format_str + sep + str(suffix)
        self.format_str = format_str
        self.logger = logger
        self.start = None
        self.end = None
        self.verbose = verbose

    @property
    def duration(self):
        if self.end is None:
            return 0
        return self.end - self.start

    def __enter__(self):
        self.start = time()

    def __exit__(self, exc_type, exc_val, exc_tb):
        self.end = time()
        out_str = self.format_str.format(self.duration)
        if self.logger:
            self.logger.info(out_str)
        else:
            print(out_str)
```


```python
import warnings
warnings.filterwarnings('ignore')

import gc
gc.collect()
```




    257



## ç–‘ä¼¼ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ


```python
import pandas as pd
import numpy as np
import random
from datetime import datetime, timedelta

def seed(seed=42):
    np.random.seed(seed)
    random.seed(seed)
seed(42)

# ãƒ‡ãƒ¼ã‚¿ä»¶æ•°ã¨ç•°å¸¸å€¤ã®æ•°ã‚’10:1ã«ãªã‚‹ã‚ˆã†ã«è¨­å®š
data_size = 1000
num_anomalies = 100

# æ—¥ä»˜ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
date_rng = pd.date_range(start='2021-01-01', end='2021-12-31', freq='S')
date_rng = np.random.choice(date_rng, data_size, replace=False)
date_rng.sort()

# ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ã®æ­£è¦åˆ†å¸ƒã«å¾“ã£ãŸãƒ©ãƒ³ãƒ€ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
response_time_data = np.random.normal(loc=200, scale=20, size=data_size)

# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
status_codes = ['200', '201', '204', '400', '401', '403', '404', '500', '502', '503']
status_code_probs = [0.6, 0.1, 0.05, 0.1, 0.02, 0.02, 0.08, 0.01, 0.01, 0.01]
status_code_data = np.random.choice(status_codes, size=data_size, p=status_code_probs)

# ç•°å¸¸å€¤ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«æŒ¿å…¥
anomaly_indices = random.sample(range(data_size), num_anomalies)
for idx in anomaly_indices:
    response_time_data[idx] = np.random.normal(loc=1000, scale=100)
    status_code_data[idx] = random.choice(['404', '500', '502', '503'])

# ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½œæˆ
# df = pd.DataFrame(data={'response_time': response_time_data, 'status_code': status_code_data}, index=date_rng)
df = pd.DataFrame(data={'date_time': date_rng, 'response_time': response_time_data, 'status_code': status_code_data})

```


```python
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date_time</th>
      <th>response_time</th>
      <th>status_code</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2021-01-01 01:13:30</td>
      <td>235.196490</td>
      <td>201</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2021-01-01 14:29:43</td>
      <td>216.519988</td>
      <td>200</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2021-01-02 03:15:21</td>
      <td>188.627762</td>
      <td>200</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2021-01-02 10:17:39</td>
      <td>181.143408</td>
      <td>200</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2021-01-02 16:28:55</td>
      <td>189.266348</td>
      <td>400</td>
    </tr>
  </tbody>
</table>
</div>



## ãƒ‡ãƒ¼ã‚¿æ¦‚è¦å¯è¦–åŒ–


```python
start_time = time()
```


```python
import matplotlib.pyplot as plt
import japanize_matplotlib

import seaborn as sns
plt.style.use('fivethirtyeight')

def plot_count(feature, title, df, size=1):
    """ã‚¯ãƒ©ã‚¹/ç‰¹å¾´é‡ã‚’ãƒ—ãƒ­ãƒƒãƒˆã™ã‚‹
    Pram:
        feature : åˆ†æã™ã‚‹ã‚«ãƒ©ãƒ 
        title : ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒˆãƒ«
        df : ãƒ—ãƒ­ãƒƒãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
        size : ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 1.
    """
    f, ax = plt.subplots(1,1, figsize=(4*size,4))
    total = float(len(df))
    # æœ€å¤§20ã‚«ãƒ©ãƒ ã‚’ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã§è¡¨ç¤º
#     g = sns.countplot(data=df, x = feature, order = df[feature].value_counts().index[:20], palette='Set3')
    g = sns.countplot(data=df, y = feature, order = df[feature].value_counts().index[:10], palette='Set3')
    # g.set_title("Number and percentage of {}".format(title))
    g.set_title("{}ã®å‰²åˆ".format(title))
    
#     if(size > 2):
        # ã‚µã‚¤ã‚º2ä»¥ä¸Šã®æ™‚ã€è¡Œåã‚’90Â°å›è»¢ã—ã€è¡¨ç¤º
#         plt.xticks(rotation=90, size=8)
    # ãƒ‡ãƒ¼ã‚¿æ¯”ç‡ã®è¡¨ç¤º
    for p in ax.patches:
        height = p.get_height()
        width = p.get_width()
#         ax.text(p.get_x()+p.get_width()/2.,
#                 height + 3,
#                 '{:1.2f}%'.format(100*height/total),
#                 ha="center")
        ax.text(width + 40,
                p.get_y()+p.get_height()+.025/2.,
                '{:1.2f}%'.format(100*width/total),
                ha="right") 
    plt.tight_layout()
    plt.show()
```


```python
# å…¨ãƒ‡ãƒ¼ã‚¿ã®status_codeã®æ¯”ç‡ã‚’ç¢ºèªã™ã‚‹
plot_count(feature='status_code', title='status_code', df=df, size=3.5)
```


    
![png](output_11_0.png)
    



```python
df['status_code'].value_counts()
```




    status_code
    200    544
    404     96
    201     86
    400     84
    204     52
    500     39
    503     36
    502     33
    403     20
    401     10
    Name: count, dtype: int64




```python
print(f'Number of all data: {df.shape[0]}')
```

    Number of all data: 1000



```python
import matplotlib.dates as mdates

# æ™‚ç³»åˆ—å¯è¦–åŒ–
def time_prot(df, threshold=0, lebel_name='threshold', color='darkblue', title='response_time ã®æ™‚ç³»åˆ—æ¨ç§»'):
    fig, ax = plt.subplots(1,1, figsize=(4*3.2,4))
    ax.plot(df['date_time'], df['response_time'], marker='o', color='lightskyblue')

    # response_timeãŒ800ä»¥ä¸Šã®ãƒ‡ãƒ¼ã‚¿ã®status_codeã‚’è¡¨ç¤º
    for index, row in df.iterrows():
        if threshold != 0:
            if row['response_time'] >= threshold:
                # ax.text(row['date_time'], row['response_time'], str(row['status_code']), backgroundcolor="lightyellow")
                ax.text(row['date_time'], row['response_time'], str(row['status_code']), size=8)

    # xè»¸ã®è¨­å®š
    # ax.xaxis.set_major_formatter(mdates.DateFormatter('%Y-%m-%d %H:%M'))
    ax.xaxis.set_major_formatter(mdates.DateFormatter('%Y-%m-%d'))
    # plt.xticks(rotation=45)
    plt.xticks(rotation=25)

    # é–¾å€¤ã®è¡¨ç¤º
    if threshold != 0:
        ax.axhline(y=threshold, c=color, linewidth = 1.6, alpha=0.64, label=lebel_name)
        # å‡¡ä¾‹ã®è¨­å®š
        # ax.legend(loc='upper left')
        ax.legend()

    # ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ©ãƒ™ãƒ«ã®è¨­å®š
    plt.title(title)
    plt.xlabel('Date Time')
    plt.ylabel('Response Time')
    plt.tight_layout()
    plt.show()
```


```python
time_prot(df, threshold)
```


    
![png](output_15_0.png)
    



```python
df[df['response_time'] >= threshold]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date_time</th>
      <th>response_time</th>
      <th>status_code</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>25</th>
      <td>2021-01-13 05:21:11</td>
      <td>1124.366513</td>
      <td>500</td>
    </tr>
    <tr>
      <th>27</th>
      <td>2021-01-13 15:37:20</td>
      <td>1045.896602</td>
      <td>502</td>
    </tr>
    <tr>
      <th>30</th>
      <td>2021-01-14 04:53:20</td>
      <td>1049.931362</td>
      <td>502</td>
    </tr>
    <tr>
      <th>44</th>
      <td>2021-01-17 09:57:30</td>
      <td>1011.391710</td>
      <td>500</td>
    </tr>
    <tr>
      <th>80</th>
      <td>2021-01-30 08:08:47</td>
      <td>1016.802237</td>
      <td>404</td>
    </tr>
    <tr>
      <th>89</th>
      <td>2021-02-04 21:53:57</td>
      <td>1104.939942</td>
      <td>503</td>
    </tr>
    <tr>
      <th>95</th>
      <td>2021-02-06 18:43:58</td>
      <td>1003.455028</td>
      <td>500</td>
    </tr>
    <tr>
      <th>99</th>
      <td>2021-02-07 16:04:52</td>
      <td>1068.312356</td>
      <td>503</td>
    </tr>
    <tr>
      <th>104</th>
      <td>2021-02-09 01:14:46</td>
      <td>1107.179114</td>
      <td>502</td>
    </tr>
    <tr>
      <th>114</th>
      <td>2021-02-15 05:49:43</td>
      <td>1048.247816</td>
      <td>404</td>
    </tr>
    <tr>
      <th>127</th>
      <td>2021-02-20 03:53:35</td>
      <td>1079.416588</td>
      <td>502</td>
    </tr>
    <tr>
      <th>142</th>
      <td>2021-02-25 19:08:39</td>
      <td>1110.090483</td>
      <td>502</td>
    </tr>
    <tr>
      <th>163</th>
      <td>2021-03-05 21:08:30</td>
      <td>1040.464885</td>
      <td>503</td>
    </tr>
    <tr>
      <th>166</th>
      <td>2021-03-07 12:10:02</td>
      <td>1034.677382</td>
      <td>404</td>
    </tr>
    <tr>
      <th>196</th>
      <td>2021-03-17 13:34:40</td>
      <td>1004.078148</td>
      <td>404</td>
    </tr>
    <tr>
      <th>203</th>
      <td>2021-03-19 21:00:56</td>
      <td>1015.805468</td>
      <td>500</td>
    </tr>
    <tr>
      <th>214</th>
      <td>2021-03-23 10:01:46</td>
      <td>1094.918171</td>
      <td>404</td>
    </tr>
    <tr>
      <th>220</th>
      <td>2021-03-25 19:57:01</td>
      <td>1061.683363</td>
      <td>502</td>
    </tr>
    <tr>
      <th>223</th>
      <td>2021-03-26 08:06:39</td>
      <td>1057.038911</td>
      <td>503</td>
    </tr>
    <tr>
      <th>233</th>
      <td>2021-03-29 12:20:14</td>
      <td>1040.659326</td>
      <td>502</td>
    </tr>
    <tr>
      <th>250</th>
      <td>2021-04-03 09:20:39</td>
      <td>1012.544021</td>
      <td>503</td>
    </tr>
    <tr>
      <th>281</th>
      <td>2021-04-15 22:55:53</td>
      <td>1064.824344</td>
      <td>500</td>
    </tr>
    <tr>
      <th>296</th>
      <td>2021-04-23 01:10:46</td>
      <td>1050.135021</td>
      <td>500</td>
    </tr>
    <tr>
      <th>300</th>
      <td>2021-04-23 23:41:40</td>
      <td>1246.258677</td>
      <td>502</td>
    </tr>
    <tr>
      <th>429</th>
      <td>2021-06-06 01:38:11</td>
      <td>1125.659602</td>
      <td>500</td>
    </tr>
    <tr>
      <th>432</th>
      <td>2021-06-06 11:54:03</td>
      <td>1053.749146</td>
      <td>404</td>
    </tr>
    <tr>
      <th>459</th>
      <td>2021-06-19 14:20:14</td>
      <td>1000.740886</td>
      <td>503</td>
    </tr>
    <tr>
      <th>470</th>
      <td>2021-06-24 18:21:28</td>
      <td>1076.874877</td>
      <td>500</td>
    </tr>
    <tr>
      <th>549</th>
      <td>2021-07-24 08:44:28</td>
      <td>1090.182137</td>
      <td>404</td>
    </tr>
    <tr>
      <th>558</th>
      <td>2021-07-27 07:48:37</td>
      <td>1184.970069</td>
      <td>502</td>
    </tr>
    <tr>
      <th>591</th>
      <td>2021-08-10 11:30:35</td>
      <td>1013.334766</td>
      <td>503</td>
    </tr>
    <tr>
      <th>604</th>
      <td>2021-08-13 21:18:14</td>
      <td>1173.805152</td>
      <td>502</td>
    </tr>
    <tr>
      <th>616</th>
      <td>2021-08-18 01:01:21</td>
      <td>1228.750114</td>
      <td>500</td>
    </tr>
    <tr>
      <th>643</th>
      <td>2021-08-26 20:19:23</td>
      <td>1116.461138</td>
      <td>500</td>
    </tr>
    <tr>
      <th>650</th>
      <td>2021-08-29 03:20:05</td>
      <td>1047.428335</td>
      <td>500</td>
    </tr>
    <tr>
      <th>665</th>
      <td>2021-09-03 14:55:57</td>
      <td>1080.860239</td>
      <td>503</td>
    </tr>
    <tr>
      <th>714</th>
      <td>2021-09-19 19:59:01</td>
      <td>1061.391051</td>
      <td>503</td>
    </tr>
    <tr>
      <th>718</th>
      <td>2021-09-21 09:48:56</td>
      <td>1001.166794</td>
      <td>503</td>
    </tr>
    <tr>
      <th>721</th>
      <td>2021-09-22 13:27:14</td>
      <td>1127.094508</td>
      <td>500</td>
    </tr>
    <tr>
      <th>754</th>
      <td>2021-10-03 19:56:42</td>
      <td>1048.110733</td>
      <td>500</td>
    </tr>
    <tr>
      <th>758</th>
      <td>2021-10-04 15:54:42</td>
      <td>1019.475151</td>
      <td>500</td>
    </tr>
    <tr>
      <th>759</th>
      <td>2021-10-04 18:23:48</td>
      <td>1039.034874</td>
      <td>500</td>
    </tr>
    <tr>
      <th>777</th>
      <td>2021-10-09 21:12:59</td>
      <td>1066.065949</td>
      <td>503</td>
    </tr>
    <tr>
      <th>791</th>
      <td>2021-10-12 16:17:03</td>
      <td>1042.909050</td>
      <td>503</td>
    </tr>
    <tr>
      <th>825</th>
      <td>2021-10-23 14:51:17</td>
      <td>1041.578415</td>
      <td>404</td>
    </tr>
    <tr>
      <th>828</th>
      <td>2021-10-24 01:00:23</td>
      <td>1052.115665</td>
      <td>404</td>
    </tr>
    <tr>
      <th>854</th>
      <td>2021-11-03 06:21:13</td>
      <td>1008.916431</td>
      <td>404</td>
    </tr>
    <tr>
      <th>890</th>
      <td>2021-11-17 22:46:27</td>
      <td>1006.307230</td>
      <td>500</td>
    </tr>
    <tr>
      <th>906</th>
      <td>2021-11-23 11:08:10</td>
      <td>1049.682995</td>
      <td>500</td>
    </tr>
    <tr>
      <th>954</th>
      <td>2021-12-14 03:50:13</td>
      <td>1050.799370</td>
      <td>404</td>
    </tr>
    <tr>
      <th>964</th>
      <td>2021-12-17 18:15:30</td>
      <td>1169.843472</td>
      <td>404</td>
    </tr>
    <tr>
      <th>983</th>
      <td>2021-12-23 15:59:17</td>
      <td>1039.860099</td>
      <td>503</td>
    </tr>
    <tr>
      <th>986</th>
      <td>2021-12-24 09:14:18</td>
      <td>1081.662818</td>
      <td>502</td>
    </tr>
  </tbody>
</table>
</div>




```python
import matplotlib.pyplot as plt
import seaborn as sns
plt.style.use('fivethirtyeight')

def res_plot_count(feature, title, df, size=1):
    """ã‚¯ãƒ©ã‚¹/ç‰¹å¾´é‡ã‚’ãƒ—ãƒ­ãƒƒãƒˆã™ã‚‹
    Pram:
        feature : åˆ†æã™ã‚‹ã‚«ãƒ©ãƒ 
        title : ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒˆãƒ«
        df : ãƒ—ãƒ­ãƒƒãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
        size : ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 1.
    """
    f, ax = plt.subplots(1,1, figsize=(32*size,4))
    total = float(len(df))
    # æœ€å¤§20ã‚«ãƒ©ãƒ ã‚’ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã§è¡¨ç¤º
#     g = sns.countplot(data=df, x = feature, order = df[feature].value_counts().index[:20], palette='Set3')
    g = sns.countplot(data=df, y = feature, order = df[feature].value_counts().index[:10], palette='Set3')
    # g.set_title("Setting Anomaly Data\nNumber and percentage of {}".format(title), size=16)
    g.set_title("ç•°å¸¸ã¨ã—ã¦åˆ†é¡ã•ã‚Œã‚‹ {} ã®æ•°ã¨å‰²åˆ".format(title), size=16)
    
    
#     if(size > 2):
        # ã‚µã‚¤ã‚º2ä»¥ä¸Šã®æ™‚ã€è¡Œåã‚’90Â°å›è»¢ã—ã€è¡¨ç¤º
#         plt.xticks(rotation=90, size=8)
    # ãƒ‡ãƒ¼ã‚¿æ¯”ç‡ã®è¡¨ç¤º
    for p in ax.patches:
        height = p.get_height()
        width = p.get_width()
#         ax.text(p.get_x()+p.get_width()/2.,
#                 height + 3,
#                 '{:1.2f}%'.format(100*height/total),
#                 ha="center")
        ax.text(width - 0.05,
                p.get_y()+p.get_height()-.05,
                f'Amount of data: {width}\nRatio: '+'{:1.2f}%'.format(100*width/total),
                ha="right") 
    plt.tight_layout()
    plt.show()
```


```python
# response_time=1000ã‚’ç•°å¸¸ã¨åˆ†é¡ã—ãŸæ™‚ã®ç•°å¸¸ãƒ‡ãƒ¼ã‚¿ã®status_codeã®æ¯”ç‡ã‚’ç¢ºèªã™ã‚‹
res_plot_count(feature='status_code', title='status_code', df=df[df['response_time'] >= threshold], size=0.32)
```


    
![png](output_18_0.png)
    



```python
df[df['response_time'] >= threshold]['status_code'].value_counts()
```




    status_code
    500    17
    503    13
    404    12
    502    11
    Name: count, dtype: int64




```python
anomaly_num = df[df['response_time'] >= threshold].shape[0]
print(f'Number of Anomaly data: {anomaly_num}')
```

    Number of Anomaly data: 53



```python
# æ¦‚è¦å¯è¦–åŒ–å‡ºåŠ›ã®å‡¦ç†æ™‚é–“
end_time = time()

elapsed_time = end_time - start_time
print(f"æ¦‚è¦å¯è¦–åŒ–å‡ºåŠ›ã®å‡¦ç†æ™‚é–“: {elapsed_time}ç§’")
```

    æ¦‚è¦å¯è¦–åŒ–å‡ºåŠ›ã®å‡¦ç†æ™‚é–“: 1.070552110671997ç§’


# ç°¡æ˜“åˆ†æã®å®Ÿæ–½


```python
start_time = time()
```

## åˆ†æã®å‰ã«ç›®çš„å¤‰æ•°ã®æ­£è¦æ€§ã®ç¢ºèª


```python
import matplotlib.gridspec as gridspec
from matplotlib.ticker import MaxNLocator
from scipy import stats
from scipy.stats import norm
```


```python
def plot_dist3(df, feature, title):
    """
    ã‚«ãƒ©ãƒ ãŒé€£ç¶šå€¤ç”¨ã®å¯è¦–åŒ–é–¢æ•°
    """
    fig = plt.figure(constrained_layout=True)
    fig.set_size_inches(16, 9)
    # 3åˆ—ã€3è¡Œã®ã‚°ãƒªãƒƒãƒ‰ã‚’ä½œæˆã—ã¾ã™
    grid = gridspec.GridSpec(ncols=3, nrows=2, figure=fig)

    # ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã®å›³ç¤º    
    ax1 = fig.add_subplot(grid[0, :2])
    ax1.set_title('Histogram')
    
    # seaborn v0.14.0 removed
    # Please adapt your code to use either `displot` 
    # (a figure-level function with similar flexibility) or 
    # `histplot` (an axes-level function for histograms).
    # sns.distplot(df.loc[:, feature],
    #              hist=True,
    #              kde=True,
    #              fit=norm,
    #               hist_kws={
    #              'rwidth': 0.85,
    #              'edgecolor': 'black',
    #              'alpha': 0.8},
    #              ax=ax1,
    #              color='darkorange')

    sns.histplot(df.loc[:, feature],
                 kde=True,
                 hue_order =(0, 1),
                 bins=30,
                 color='darkorange',
                 ax=ax1,)

    ax1.axvline(df.loc[:, feature].mean(), color='darkblue', linestyle='dashed', linewidth=3)
    min_ylim, max_ylim = plt.ylim()
    # å¹³å‡å€¤ã®è¡¨ç¤º
    ax1.text(df.loc[:, feature].mean()*1.05, max_ylim*0.85, 'Mean: {:.2f}'.format(df.loc[:, feature].mean()), color='Black', fontsize='12',
             bbox=dict(boxstyle='round',facecolor='darkorange', alpha=0.5))
    ax1.legend(labels=['Actual','Normal'])
    ax1.xaxis.set_major_locator(MaxNLocator(nbins=24))

    # QQãƒ—ãƒ­ãƒƒãƒˆ
    ax2 = fig.add_subplot(grid[1, :2])
    ax2.set_title('Probability Plot')
    stats.probplot(df.loc[:, feature].fillna(np.mean(df.loc[:, feature])),
                   plot=ax2)
    ax2.get_lines()[0].set_markerfacecolor('#e74c3c')
    ax2.get_lines()[0].set_markersize(12.0)
    ax2.xaxis.set_major_locator(MaxNLocator(nbins=24))

    # Box Plot
    ax3 = fig.add_subplot(grid[:, 2])
    ax3.set_title('Box Plot')
    sns.boxplot(y=feature, data=df, ax=ax3, palette='Set3')
    ax3.yaxis.set_major_locator(MaxNLocator(nbins=24))

    plt.suptitle(f'{title}', fontsize=24)
```


```python
# å…¨ãƒ‡ãƒ¼ã‚¿ã§ã®æ­£è¦æ€§ã®ç¢ºèª
plot_dist3(df, 'response_time', 'Readability Score Distribution')
```


    
![png](output_27_0.png)
    



```python
# ä»®å®šã§è¨­å®šã—ã¦ã„ã‚‹ç¾é–¾å€¤ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã§æ­£è¦æ€§ã‚’ç¢ºèª
plot_dist3(df[df['response_time'] < threshold], 'response_time', 'Below Threshold data Readability Score Distribution')
```


    
![png](output_28_0.png)
    



```python
# ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆæ™‚ã«å¤–ã‚Œå€¤ã¨ã—ã¦è¨­å®šã—ãŸ800ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã§æ­£è¦æ€§ç¢ºèª
plot_dist3(df[df['response_time'] < 800], 'response_time', 'Generation Threshold data Readability Score Distribution')
```


    
![png](output_29_0.png)
    




## æ¬ æå€¤ã®ç¢ºèª


```python
# æ¬ æå€¤è¨ˆç®—é–¢æ•°
def missing_value_table(df):
    """æ¬ æå€¤ã®æ•°ã¨ã‚«ãƒ©ãƒ ã”ã¨ã®å‰²åˆã®å–å¾—
    Param : DataFrame
    ç¢ºèªã‚’è¡Œã†ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
    """
    # æ¬ æå€¤ã®åˆè¨ˆ
    mis_val = df.isnull().sum()
    # ã‚«ãƒ©ãƒ ã”ã¨ã®æ¬ æå€¤ã®å‰²åˆ
    mis_val_percent = 100 * mis_val / len(df)
    # æ¬ æå€¤ã®åˆè¨ˆã¨å‰²åˆã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«çµåˆ
    mis_val_table = pd.concat([mis_val, mis_val_percent], axis=1)
    # ã‚«ãƒ©ãƒ åã®ç·¨é›†
    mis_val_table = mis_val_table.rename(
        columns={0:'Missing Values', 1:'% of Total Values'}
    )
    # ãƒ‡ãƒ¼ã‚¿ã‚’æ¬ æå€¤ã®ã‚ã‚‹ã‚‚ã®ã ã‘ã«ã—ã€‚å°æ•°ç‚¹ä»¥ä¸‹1æ¡è¡¨ç¤ºã§é™é †ã‚½ãƒ¼ãƒˆã™ã‚‹
    mis_val_table = mis_val_table[mis_val_table.iloc[:, 1] != 0].sort_values(
        '% of Total Values', ascending=False
    ).round(1)

    # æ¬ æå€¤ã‚’ã‚‚ã¤ã‚«ãƒ©ãƒ æ•°ã®è¡¨ç¤º
    print('ã“ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®ã‚«ãƒ©ãƒ æ•°ã¯ã€', df.shape[1])
    print('ã“ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®æ¬ æå€¤åˆ—æ•°ã¯ã€', mis_val_table.shape[0])
    # æ¬ æå€¤ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¿”ã™
    return mis_val_table
```


```python
missing_value_table(df)
```

    ã“ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®ã‚«ãƒ©ãƒ æ•°ã¯ã€ 3
    ã“ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®æ¬ æå€¤åˆ—æ•°ã¯ã€ 0





<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Missing Values</th>
      <th>% of Total Values</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div>




```python
# æ¬ æå€¤ã¯ãªã„ãŒä¸€å¿œé™¤å¤–å‡¦ç†
df.dropna(how='all', inplace=True)
```

## å­¦ç¿’ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ

å››åˆ†ä½ç¯„å›²å¤–ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç•°å¸¸å€¤ã¨ä»®å®šã—ã¦é™¤å¤–ã—ã¦ã€ãã®åŠåˆ†ã‚’å­¦ç¿’ã«ä½¿ç”¨ã™ã‚‹


```python
def remove_outlier(df_in, col_name):
    """
    ã‚«ãƒ©ãƒ ãƒ‡ãƒ¼ã‚¿ã®å››åˆ†ä½ç¯„å›²å¤–ã®é™¤å¤–
    Parametr:
        df_in:
            å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
        col_name:
            å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚«ãƒ©ãƒ å
    Return:
        å››åˆ†ä½ç¯„å›²å¤–ã‚’é™¤å¤–ã—ãŸã‚«ãƒ©ãƒ ãƒ‡ãƒ¼ã‚¿
    """
    # å››åˆ†ä½ç¯„å›²ã®ç®—å‡º
    q1 = df_in[col_name].quantile(0.25)     # ç¬¬ä¸€å››åˆ†ä½æ•° 25%ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«
    q3 = df_in[col_name].quantile(0.75)     # ç¬¬ä¸‰å››åˆ†ä½æ•° 75%ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«
    iqr = q3-q1                             # å››åˆ†ä½ç¯„å›²
    # å¤–ã‚Œå€¤ã«å½“ãŸã‚‹ç¯„å›²ã‚’ç®—å‡º
    fence_low  = q1 - 1.5*iqr               # ç¬¬ä¸€å››åˆ†ä½æ•°-ç¬¬å››å››åˆ†ä½æ•°
    fence_high = q3 + 1.5*iqr               # ç¬¬ä¸‰å››åˆ†ä½æ•°-ç¬¬å››å››åˆ†ä½æ•°
    
    # return fence_low, fence_high
    # ç¯„å›²å¤–ã®é™¤å¤–
    df_out = df_in.loc[(df_in[col_name] > fence_low) & (df_in[col_name] < fence_high)]
    
    df_in = df_in.loc[(df_in[col_name] <= fence_low) | (df_in[col_name] >= fence_high)]
    return df_out, df_in
```


```python
# å››åˆ†ä½ç¯„å›²å¤–ã®ãƒ‡ãƒ¼ã‚¿ã®é™¤å¤–
df_out, df_in = remove_outlier(df, 'response_time')
df_out.reset_index(inplace=True, drop=True)

# é™¤å¤–çµæœ
df.shape, df_out.shape, df_in.shape
```




    ((1000, 3), (897, 3), (103, 3))




```python
plot_dist3(df_out, 'response_time', 'ç›®çš„å¤‰æ•°ã®ãƒ‡ãƒ¼ã‚¿åˆ†å¸ƒ')
```


    
![png](output_38_0.png)
    



```python
time_prot(df_out, title='å­¦ç¿’ã«ä½¿ç”¨ã™ã‚‹ response_time ã®æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã®æ¨ç§»')
```


    
![png](output_39_0.png)
    



```python
# dfã®è¡Œæ•°ã‚’å–å¾—ã—ã€åŠåˆ†ã‚’è¨ˆç®—ã™ã‚‹
half_len = len(df_out) // 2

# æœ€åˆã®åŠåˆ†ã®è¡Œã‚’æŠ½å‡ºã™ã‚‹
train_df = df_out.iloc[:half_len]
train_df.reset_index(inplace=True, drop=True)
```


```python
valid_df = pd.concat([df_out.iloc[half_len:], df_in])
valid_df = valid_df.sort_values('date_time')

valid_df.reset_index(inplace=True, drop=True)
```


```python
train_df.shape, valid_df.shape
```




    ((448, 3), (552, 3))



## LOFã«ã‚ˆã‚‹ç°¡æ˜“åˆ†æã®å®Ÿè¡Œ


```python
start_time = time()
```


```python
from sklearn.neighbors import LocalOutlierFactor
```


```python
# LOFã®è¿‘å‚æ•°kã‚’å¤‰åŒ–ã•ã›ã¦æ¤œè¨¼ç”¨ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã™ã‚‹äºˆæ¸¬çµæœã‚’å–å¾—(
preds = []
for k in range(1,11):
    with Timer(prefix=f'n_neighbors k={k}'):
        # è¿‘å‚æ•°ã‚’è¨­å®šã—ã¦LOFã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
        lof = LocalOutlierFactor(n_neighbors=k, novelty=True, contamination='auto')
        lof.fit(train_df.drop(['date_time', 'status_code'], axis=1))
        pred = lof._predict(valid_df.drop(['date_time', 'status_code'], axis=1))
        
        preds.append(pred)
```

    n_neighbors k=1 0.004[s]
    n_neighbors k=2 0.004[s]
    n_neighbors k=3 0.003[s]
    n_neighbors k=4 0.005[s]
    n_neighbors k=5 0.004[s]
    n_neighbors k=6 0.003[s]
    n_neighbors k=7 0.003[s]
    n_neighbors k=8 0.003[s]
    n_neighbors k=9 0.004[s]
    n_neighbors k=10 0.003[s]



```python
# äºˆæ¸¬çµæœã®å¹³å‡ã‚’ã¨ã‚Šã€0ä»¥ä¸Šãªã‚‰1(æ­£å¸¸)ã€ä»¥ä¸‹ãªã‚‰-1(ç•°å¸¸)ã«è¨­å®š
pred = np.mean(preds, axis=0)
pred[pred >= 0] = 1
pred[pred < 0] = -1
```


```python
valid_df['judgment'] = pred
```


```python
time_prot(valid_df, title='æ¤œè¨¼ã«ä½¿ç”¨ã™ã‚‹ response_time ã®æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã®æ¨ç§»')
```


    
![png](output_49_0.png)
    



```python
valid_df['judgment'].value_counts()
```




    judgment
     1.0    408
    -1.0    144
    Name: count, dtype: int64



## æ–°ã—ã„é–¾å€¤ã®è¨­å®šã¨å¯è¦–åŒ–


```python
# ç•°å¸¸ã¨äºˆæ¸¬ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’é–¾å€¤è¨­å®šç”¨ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦å–å¾—
pred_anomaly_df = valid_df[valid_df['judgment']==-1].copy()
pred_anomaly_df.reset_index(inplace=True, drop=True)
```


```python
pred_anomaly_df['judgment'].value_counts()
```




    judgment
    -1.0    144
    Name: count, dtype: int64




```python
# 500ã¨503ã«å¯¾ã—ã¦é‡ã¿ã‚’è¨­å®šã—ãŸåŠ é‡å¹³å‡ã‚’ç®—å‡ºã—æ–°ã—ã„é–¾å€¤ã¨ã™ã‚‹
w_500 = 1.5
w_503 = 1.2

pred_anomaly_df['weights'] = 1.0
pred_anomaly_df.loc[pred_anomaly_df['status_code'] == '500', 'weights'] = w_500
pred_anomaly_df.loc[pred_anomaly_df['status_code'] == '503', 'weights'] = w_503

weighted_mean = (pred_anomaly_df['response_time'] * pred_anomaly_df['weights']).sum() / pred_anomaly_df['weights'].sum()
simple_mean = pred_anomaly_df['response_time'].mean()

# ç•°å¸¸ã¨åˆ†é¡ã—ãŸãƒ‡ãƒ¼ã‚¿æ•°ãŒå°‘ãªã„ã®ã‚‚ã‚ã‚‹ãŒçµæœã¯ã»ã¼åŒã˜ã«ãªã£ãŸ
print('Weighted Mean:', weighted_mean)
print('Simple Mean:  ', simple_mean)

# æ–°ã—ã„é–¾å€¤ã‚’ã‚»ãƒƒãƒˆ
new_threshold = weighted_mean
print('New Threshold:', new_threshold)
```

    Weighted Mean: 781.3846612433357
    Simple Mean:   753.3878771255627
    New Threshold: 781.3846612433357


## ç°¡æ˜“åˆ†æã®çµæœ


```python
# GPTãŒç”Ÿæˆã—ãŸæ–‡ç« ã®å‰ã«ä»˜ã‘ã‚‹æ–‡ç« ä¾‹
print(f'ç°¡æ˜“çš„ã«åˆ†æã‚’è¡Œã„ã€å†è¨­å®šã™ã‚‹å ´åˆã®é–¾å€¤ã‚’è€ƒãˆã¾ã—ãŸã€‚\nä»¥ä¸‹ã®ã‚¢ãƒ©ãƒ¼ãƒ ç™ºå ±æ™‚ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å››åˆ†ä½ç¯„å›²å¤–ã‚’é™¤å¤–ã—ãŸçµæœã‚’æ­£å¸¸ã§ã‚ã‚‹ã¨ä»®å®šã—ã€ãã®ãƒ‡ãƒ¼ã‚¿ã®åŠåˆ†ã§ã‚ã‚‹{half_len}è¡Œã‚’å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚')
```

    ç°¡æ˜“çš„ã«åˆ†æã‚’è¡Œã„ã€å†è¨­å®šã™ã‚‹å ´åˆã®é–¾å€¤ã‚’è€ƒãˆã¾ã—ãŸã€‚
    ä»¥ä¸‹ã®ã‚¢ãƒ©ãƒ¼ãƒ ç™ºå ±æ™‚ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å››åˆ†ä½ç¯„å›²å¤–ã‚’é™¤å¤–ã—ãŸçµæœã‚’æ­£å¸¸ã§ã‚ã‚‹ã¨ä»®å®šã—ã€ãã®ãƒ‡ãƒ¼ã‚¿ã®åŠåˆ†ã§ã‚ã‚‹448è¡Œã‚’å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚



```python
# å…¨ãƒ‡ãƒ¼ã‚¿ã§ã®æ­£è¦æ€§ã®ç¢ºèª
plot_dist3(df, 'response_time', 'ç›®çš„å¤‰æ•°ã®ãƒ‡ãƒ¼ã‚¿åˆ†å¸ƒ')
```


    
![png](output_57_0.png)
    



```python
time_prot(train_df, title='å­¦ç¿’ã«ä½¿ç”¨ã—ãŸ response_time ã®æ™‚ç³»åˆ—æ¨ç§»')
```


    
![png](output_58_0.png)
    



```python
time_prot(valid_df, new_threshold, lebel_name='new_threshold', color='darkred', title='å­¦ç¿’ã«ã¯ä½¿ç”¨ã›ãšé–¾å€¤è¨­å®šæ™‚ã«ã®ã¿ä½¿ç”¨ã—ãŸ response_time ã®æ™‚ç³»åˆ—æ¨ç§»')
```


    
![png](output_59_0.png)
    



```python
# GPTãŒç”Ÿæˆã—ãŸæ–‡ç« ã®å‰ã«ä»˜ã‘ã‚‹æ–‡ç« ä¾‹
print(f'é–¾å€¤ã®ä½œæˆã«ã¯LOFã‚’ä½¿ç”¨ã—ã€æ¨è«–ã§ã¯è¿‘å‚æ•°kã‚’1ï½10ã¾ã§ãã‚Œãã‚Œå¤‰ãˆãŸã¨ãã®çµæœã®å¹³å‡ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚\nææ¡ˆã—ãŸã„é–¾å€¤ã¯ã€ç•°å¸¸ã¨åˆ†é¡ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ä¸­ã§HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ500ã¾ãŸã¯503ã§ã‚ã‚‹å ´åˆã«é‡ã¿ã‚’ä»˜ä¸ã—ã€åŠ é‡å¹³å‡ã‚’ç®—å‡ºã—ãŸçµæœã§ã™ã€‚\nãƒ»æ–°ã—ã„é–¾å€¤:{new_threshold}\næ–°ã—ã„é–¾å€¤ã‚’è¨­å®šã—ãŸå ´åˆã®å¯è¦–åŒ–çµæœã¯ä»¥ä¸‹ã¨ãªã‚Šã¾ã™ã€‚')
```

    é–¾å€¤ã®ä½œæˆã«ã¯LOFã‚’ä½¿ç”¨ã—ã€æ¨è«–ã§ã¯è¿‘å‚æ•°kã‚’1ï½10ã¾ã§ãã‚Œãã‚Œå¤‰ãˆãŸã¨ãã®çµæœã®å¹³å‡ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚
    ææ¡ˆã—ãŸã„é–¾å€¤ã¯ã€ç•°å¸¸ã¨åˆ†é¡ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ä¸­ã§HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ500ã¾ãŸã¯503ã§ã‚ã‚‹å ´åˆã«é‡ã¿ã‚’ä»˜ä¸ã—ã€åŠ é‡å¹³å‡ã‚’ç®—å‡ºã—ãŸçµæœã§ã™ã€‚
    ãƒ»æ–°ã—ã„é–¾å€¤:781.3846612433357
    æ–°ã—ã„é–¾å€¤ã‚’è¨­å®šã—ãŸå ´åˆã®å¯è¦–åŒ–çµæœã¯ä»¥ä¸‹ã¨ãªã‚Šã¾ã™ã€‚



```python
time_prot(df, new_threshold, lebel_name='new_threshold', color='darkred', title='æ–°ã—ã„é–¾å€¤ã‚’è¨­å®šã—ãŸå ´åˆã® response_time ã®æ™‚ç³»åˆ—æ¨ç§»')
```


    
![png](output_61_0.png)
    



```python
# æ–°ã—ã„é–¾å€¤ã‚’ç•°å¸¸ã¨åˆ†é¡ã—ãŸæ™‚ã®ç•°å¸¸ã¨åˆ†é¡ã—ãŸãƒ‡ãƒ¼ã‚¿ã®status_codeã®æ¯”ç‡ã‚’ç¢ºèªã™ã‚‹
res_plot_count(feature='status_code', title='status_code', df=df[df['response_time'] >= new_threshold], size=0.32)
```


    
![png](output_62_0.png)
    



```python
# ã™ã¹ã¦ã®å‡¦ç†æ™‚é–“
end_time = time()

elapsed_time = end_time - start_time
print(f"ç°¡æ˜“åˆ†æã®å‡¦ç†æ™‚é–“: {elapsed_time}ç§’")
```

    ç°¡æ˜“åˆ†æã®å‡¦ç†æ™‚é–“: 2.0428388118743896ç§’



```python

```
